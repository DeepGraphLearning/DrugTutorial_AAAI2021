

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Graph Neural Network Layers &mdash; Drugdiscovery 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Batch Irregular Structures" href="variadic.html" />
    <link rel="prev" title="Graph Data Structures" href="graph.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Drugdiscovery
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start</a></li>
</ul>
<p class="caption"><span class="caption-text">Benchmark</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../benchmark/property_prediction.html">Molecule Property Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmark/generation.html">Graph Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmark/retrosynthesis.html">Retrosynthesis</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/property_prediction.html">Molecule Property Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/generation.html">Molecule Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/retrosynthesis.html">Retrosynthesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/link_prediction.html">Link Prediction</a></li>
</ul>
<p class="caption"><span class="caption-text">Notes</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="graph.html">Graph Data Structures</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Graph Neural Network Layers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#message-passing-layers">Message Passing Layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#readout-and-broadcast-layers">Readout and Broadcast Layers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="variadic.html">Batch Irregular Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug.html">Debug Your Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="extension.html">Custom Extensions</a></li>
</ul>
<p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/core.html">drugdiscovery.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/data.html">drugdiscovery.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/datasets.html">drugdiscovery.datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/layers.html">drugdiscovery.layers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/models.html">drugdiscovery.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/tasks.html">drugdiscovery.tasks</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Drugdiscovery</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Graph Neural Network Layers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/notes/layer.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="graph-neural-network-layers">
<h1>Graph Neural Network Layers<a class="headerlink" href="#graph-neural-network-layers" title="Permalink to this headline">¶</a></h1>
<p>Modern graph neural networks encode graph structures with message passing layers
and readout layers. In some cases, graph-to-node broadcast may also be needed. All
these operations can be easily implemented with Drugdiscovery.</p>
<div class="align-center figure align-left" id="id1">
<a class="reference internal image-reference" href="../_images/message_passing.png"><img alt="../_images/message_passing.png" src="../_images/message_passing.png" style="width: 210px;" /></a>
<p class="caption"><span class="caption-text">Message passing</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div class="align-center figure align-left" id="id2">
<a class="reference internal image-reference" href="../_images/readout.png"><img alt="../_images/readout.png" src="../_images/readout.png" style="width: 210px;" /></a>
<p class="caption"><span class="caption-text">Node-to-graph readout</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<div class="align-center figure align-left" id="id3">
<a class="reference internal image-reference" href="../_images/broadcast.png"><img alt="../_images/broadcast.png" src="../_images/broadcast.png" style="width: 210px;" /></a>
<p class="caption"><span class="caption-text">Graph-to-node broadcast</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<div style="clear: both" /><div class="section" id="message-passing-layers">
<h2>Message Passing Layers<a class="headerlink" href="#message-passing-layers" title="Permalink to this headline">¶</a></h2>
<p>A message passing layer can be described as 3 steps, a message generation step, an
aggregation step and a combination step. The <span class="math notranslate nohighlight">\(t\)</span>-th message passing layer
performs the following computation</p>
<div class="math notranslate nohighlight">
\[\begin{split}m_{i,j}^{(t+1)} &amp;= Message^{(t)}(h_i^{(t)}, h_j^{(t)}) \\
u_i^{(t+1)} &amp;= Aggregate^{(t)}(\{m_{i,j}^{(t+1)} \mid j \in N(i)\}) \\
h_i^{(t+1)} &amp;= Combine^{(t)}(h_i^{(t)}, u_i^{(t+1)})\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(h_i^{(t)}\)</span> denotes node representations, <span class="math notranslate nohighlight">\(m_{i,j}^{(t)}\)</span> denotes
messages from node <span class="math notranslate nohighlight">\(j\)</span> to node <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(u_i^{(t)}\)</span> is the
aggregated messages, i.e., updates.</p>
<p>In Drugdiscovery, these steps are abstracted as three methods, namely
<code class="xref py py-meth docutils literal notranslate"><span class="pre">message(graph,</span> <span class="pre">input)</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">aggregate(graph,</span> <span class="pre">message)</span></code> and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">combine(input,</span> <span class="pre">update)</span></code>.</p>
<p>Here we show an example of a custom message passing for <a class="reference external" href="https://en.wikipedia.org/wiki/PageRank">PageRank</a> algorithm.
Representing the PageRank value as <span class="math notranslate nohighlight">\(h_i^{(t)}\)</span>, one PageRank iteration is
equivalent to the following functions.</p>
<div class="math notranslate nohighlight">
\[\begin{split}Message^{(t)}(h_i^{(t)}, h_j^{(t)}) &amp;= \frac{h_j^{(t)}}{degree\_in_j} \\
Aggregate^{(t)}(\{m_{i,j} \mid j \in N(i)\}) &amp;= \sum_{j \in N(i)} m_{i,j} \\
Combine^{(t)}(h_i^{(t)}, u_i^{(t+1)}) &amp;= u_i^{(t+1)}\end{split}\]</div>
<p>We use the convention that <span class="math notranslate nohighlight">\(degree\_in_j\)</span> represents the degree of node
<span class="math notranslate nohighlight">\(j\)</span> as the source node of any edge. The corresponding implementation is</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch_scatter</span> <span class="kn">import</span> <span class="n">scatter_add</span>
<span class="kn">from</span> <span class="nn">drugdiscovery</span> <span class="kn">import</span> <span class="n">layers</span>

<span class="k">class</span> <span class="nc">PageRankIteration</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MessagePassingBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">node_in</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">edge_list</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">node_in</span><span class="p">]</span> <span class="o">/</span> <span class="n">graph</span><span class="o">.</span><span class="n">degree_in</span><span class="p">[</span><span class="n">node_in</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">node_out</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">edge_list</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">scatter_add</span><span class="p">(</span><span class="n">node_out</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_size</span><span class="o">=</span><span class="n">graph</span><span class="o">.</span><span class="n">num_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">update</span>

    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">update</span>
        <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>Let’s elaborate the functions one by one. In <code class="xref py py-meth docutils literal notranslate"><span class="pre">message()</span></code>, we pick the source
nodes of all edges, and compute the messages by dividing the source nodes’ hidden
states with their source degrees.</p>
<p>In <code class="xref py py-meth docutils literal notranslate"><span class="pre">aggregate()</span></code>, we collect the messages by their target nodes. This is
implemented by <code class="xref py py-func docutils literal notranslate"><span class="pre">scatter_add()</span></code> operation from <a class="reference external" href="https://pytorch-scatter.readthedocs.io">PyTorch Scatter</a>. We specify
<code class="xref py py-attr docutils literal notranslate"><span class="pre">dim_size</span></code> to be <code class="docutils literal notranslate"><span class="pre">graph.num_node</span></code>, since there might be isolated nodes in
the graph and <code class="xref py py-func docutils literal notranslate"><span class="pre">scatter_add()</span></code> cannot figure it out from <code class="docutils literal notranslate"><span class="pre">node_in</span></code>.</p>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">combine()</span></code> function trivially returns node updates as new node hidden
states.</p>
</div>
<div class="section" id="readout-and-broadcast-layers">
<h2>Readout and Broadcast Layers<a class="headerlink" href="#readout-and-broadcast-layers" title="Permalink to this headline">¶</a></h2>
<p>A readout layer collects all node representations in a graph to form a graph
representation. Reversely, a broadcast layer sends the graph representation to every
node in the graph. For a batch of graphs, these operations can be viewed as message
passing on a bipartite graph – one side are original nodes, and the other side are
“graph” nodes.</p>
<p>Drugdiscovery provides effcient primitives to support this kind of message passing.
Specifically, <code class="xref py py-attr docutils literal notranslate"><span class="pre">node2graph</span></code> maps
node IDs to graph IDs, and <code class="xref py py-attr docutils literal notranslate"><span class="pre">edge2graph</span></code>
maps edge IDs to graph IDs.</p>
<p>In this example, we will use the above primitives to compute the variance of node
representations as a graph representation. First, we readout the mean of node
representations. Second, we broadcast the mean representation to each node to compute
the difference. Finally, we readout the mean of the squared difference as the variance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch_scatter</span> <span class="kn">import</span> <span class="n">scatter_mean</span>

<span class="k">class</span> <span class="nc">Variance</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">scatter_mean</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">node2graph</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_size</span><span class="o">=</span><span class="n">graph</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">-</span> <span class="n">mean</span><span class="p">[</span><span class="n">graph</span><span class="o">.</span><span class="n">node2graph</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">scatter_mean</span><span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">node2graph</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_size</span><span class="o">=</span><span class="n">graph</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var</span>
</pre></div>
</div>
<p>Notice that <code class="xref py py-attr docutils literal notranslate"><span class="pre">node2graph</span></code> is used
for both readout and broadcast. When used in a scatter function, it serves as
readout. When used in a conventional indexing, it is equivalent to broadcast.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="variadic.html" class="btn btn-neutral float-right" title="Batch Irregular Structures" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="graph.html" class="btn btn-neutral float-left" title="Graph Data Structures" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, MilaGraph Group

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>